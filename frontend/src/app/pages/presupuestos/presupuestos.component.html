<p-toast></p-toast>

<div class="presupuesto-container">
  <!-- üìÅ Tabs -->
  <div class="tabs">
    <button [class.active]="vista === 'productos'" (click)="vista = 'productos'">Productos</button>
    <button [class.active]="vista === 'presupuestos'" (click)="vista = 'presupuestos'">Presupuestos</button>
  </div>

  <!-- üõí TAB: Productos -->
  <div *ngIf="vista === 'productos' && !mostrarFormularioFinal">
    <h2> Armado de Presupuesto | Productos disponibles</h2>

    <div class="productos-grid">
      <p-card *ngFor="let prod of productos" styleClass="producto-card">
        <ng-template pTemplate="header">
          <div class="producto-header">
            <h3 class="producto-nombre">{{ prod.nombre }}</h3>
            <span class="producto-precio">${{ prod.precioUnitario }}</span>
          </div>
        </ng-template>

        <div class="producto-descripcion">
          <p>{{ prod.descripcion }}</p>
          <small><strong>Ingredientes:</strong> {{ prod.ingredientes }}</small><br />
          <p-tag [value]="
                prod.flag === 'VEGANO'
                  ? 'Vegano'
                  : prod.flag === 'VEGETARIANO'
                  ? 'Vegetariano'
                  : 'Otro'
              " [severity]="
                prod.flag === 'VEGANO'
                  ? 'success'
                  : prod.flag === 'VEGETARIANO'
                  ? 'info'
                  : 'warning'
              " class="mt-2"></p-tag>
        </div>

        <ng-template pTemplate="footer">
          <div class="card-footer">
            <input type="number" [(ngModel)]="prod.cantidadTemp" min="1" class="cantidad-input" />
            <button pButton icon="pi pi-plus" class="p-button-success"
              (click)="agregarProducto(prod, prod.cantidadTemp || 1)">
            </button>
          </div>
        </ng-template>
      </p-card>
    </div>



    <button pButton icon="pi pi-shopping-cart" class="p-button-rounded p-button-info ver-sidebar-btn"
      (click)="mostrarSidebar = true">
    </button>

    <!-- üßæ Sidebar de resumen -->
    <p-sidebar [(visible)]="mostrarSidebar" position="right" styleClass="resumen-sidebar" [baseZIndex]="10000">
      <h3>üßæ √çtems seleccionados</h3>

      <p-table [value]="items">
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Cant.</th>
            <th>Precio</th>
            <th>Total</th>
            <th></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item let-i="rowIndex">
          <tr>
            <td>{{ item.productoId }}</td>
            <td>{{ item.cantidad }}</td>
            <td>{{ item.precioUnitario | currency: 'UYU' }}</td>
            <td>{{ item.totalItem | currency: 'UYU' }}</td>
            <td>
              <button pButton icon="pi pi-trash" class="p-button-danger p-button-sm" (click)="eliminarItem(i)">
              </button>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <div class="text-right mt-3">
        <button pButton label="Continuar ‚Üí" (click)="continuar()" class="p-button-success"></button>
      </div>
    </p-sidebar>
  </div>

  <!-- üìù Formulario final -->
  <div *ngIf="mostrarFormularioFinal && vista === 'productos'" class="formulario-final">
  <h3>üìù Completar presupuesto</h3>

  <div class="formulario-card">
    <form [formGroup]="formPresupuesto">
      <div class="form-group">
        <label for="cliente">Cliente:</label>
        <p-dropdown [options]="clientes" formControlName="clienteId" optionLabel="nombre" optionValue="id"
          placeholder="Seleccionar cliente" inputId="cliente"></p-dropdown>
      </div>

      <div class="form-group">
        <label for="estado">Estado:</label>
        <input type="text" pInputText formControlName="estado" id="estado" placeholder="Ej: Propuesta" />
      </div>

      <div class="form-group">
        <label for="tipoEvento">Tipo de evento:</label>
        <input type="text" pInputText formControlName="tipoEvento" id="tipoEvento" placeholder="Ej: Casamiento" />
      </div>

      <div class="form-group">
        <label for="gananciaEstimada">Ganancia estimada (UYU):</label>
        <p-inputNumber formControlName="gananciaEstimada" inputId="gananciaEstimada" mode="currency" currency="UYU"
          locale="es-UY" [min]="0" [showButtons]="true">
        </p-inputNumber>
      </div>

      <div class="form-group">
        <label for="comentarios">Comentarios:</label>
        <textarea pInputTextarea formControlName="comentarios" rows="3" placeholder="Notas adicionales..."></textarea>
      </div>

      <div class="form-buttons">
        <button pButton label="‚Üê Volver" class="p-button-secondary" (click)="volver()"></button>
        <button pButton label="üíæ Guardar presupuesto" class="p-button-success"
          [disabled]="formPresupuesto.invalid || items.length === 0" (click)="crearPresupuesto()"></button>
      </div>
    </form>
  </div>
</div>


  <!-- üìë TAB: Presupuestos anteriores -->
  <div *ngIf="vista === 'presupuestos'">
    <h3>üìë Presupuestos anteriores</h3>

    <p-table [value]="presupuestos">
      <ng-template pTemplate="header">
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Evento</th>
          <th>Comentarios</th>
          <th>Estado</th>
          <th>Total</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-pres>
        <tr>
          <td>{{ pres.id }}</td>
          <td>{{ pres.clienteNombre }}</td>
          <td>{{ pres.tipoEvento }}</td>
          <td>{{ pres.comentarios }}</td>
          <td>{{ pres.estado }}</td>
          <td>{{ obtenerTotal(pres) | currency: 'UYU' }}</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>