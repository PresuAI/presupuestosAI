<p-toast></p-toast>

<div class="presupuesto-container">
  <h2>üì¶ Armado de Presupuesto</h2>

  <!-- Paso 1: Selecci√≥n de productos -->
  <div *ngIf="!mostrarFormularioFinal">
    <h3>üõí Productos disponibles</h3>

    <div class="productos-grid">
      <p-card *ngFor="let prod of productos" class="producto-card">
        <ng-template pTemplate="header">
          <div class="card-header">
            <strong>{{ prod.nombre }}</strong>
            <span class="precio">{{ prod.precioUnitario | currency: 'UYU' }}</span>
          </div>
        </ng-template>

        <p>{{ prod.descripcion }}</p>

        <div class="ingredientes">
          <strong>Ingredientes:</strong>
          <span>{{ prod.ingredientes }}</span>
        </div>

        <span *ngIf="prod.flag === 'VEGANO'" class="badge vegano">Vegano</span>
        <span *ngIf="prod.flag === 'VEGETARIANO'" class="badge vegetariano">Vegetariano</span>
        <span *ngIf="prod.flag === 'OTRO'" class="badge otro">Otro</span>

        <div class="card-footer">
          <input type="number" [(ngModel)]="prod.cantidadTemp" min="1" class="cantidad-input" />
          <button
            pButton
            icon="pi pi-plus"
            class="p-button-sm p-button-success"
            (click)="agregarProducto(prod, prod.cantidadTemp || 1)">
          </button>
        </div>
      </p-card>
    </div>

    <button
      pButton
      icon="pi pi-shopping-cart"
      class="p-button-rounded p-button-info ver-sidebar-btn"
      (click)="mostrarSidebar = true">
    </button>

    <p-sidebar [(visible)]="mostrarSidebar" position="right" styleClass="resumen-sidebar" [baseZIndex]="10000">
      <h3>üßæ √çtems seleccionados</h3>

      <p-table [value]="items">
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Cant.</th>
            <th>Precio</th>
            <th>Total</th>
            <th></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item let-i="rowIndex">
          <tr>
            <td>{{ item.productoId }}</td>
            <td>{{ item.cantidad }}</td>
            <td>{{ item.precioUnitario | currency: 'UYU' }}</td>
            <td>{{ item.totalItem | currency: 'UYU' }}</td>
            <td>
              <button
                pButton
                icon="pi pi-trash"
                class="p-button-danger p-button-sm"
                (click)="eliminarItem(i)">
              </button>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <div class="text-right mt-3">
        <button pButton label="Continuar ‚Üí" (click)="continuar()" class="p-button-success"></button>
      </div>
    </p-sidebar>
  </div>

  <!-- Paso 2: Formulario final -->
  <div *ngIf="mostrarFormularioFinal">
    <h3>üìù Completar presupuesto</h3>

    <form [formGroup]="formPresupuesto">
      <div class="form-group mb-3">
        <label for="cliente">Cliente:</label>
        <p-dropdown 
          [options]="clientes" 
          formControlName="clienteId"
          optionLabel="nombre" 
          optionValue="id" 
          placeholder="Seleccionar cliente"
          inputId="cliente">
        </p-dropdown>
      </div>

      <div class="form-group mb-3">
        <label for="estado">Estado:</label>
        <input type="text" pInputText formControlName="estado" id="estado" placeholder="Ej: Propuesta" />
      </div>

      <div class="form-group mb-3">
        <label for="tipoEvento">Tipo de evento:</label>
        <input type="text" pInputText formControlName="tipoEvento" id="tipoEvento" placeholder="Ej: Casamiento" />
      </div>

      <div class="form-group mb-3">
        <label for="gananciaEstimada">Ganancia estimada (UYU):</label>
        <p-inputNumber 
          formControlName="gananciaEstimada"
          inputId="gananciaEstimada" 
          mode="currency" 
          currency="UYU" 
          locale="es-UY" 
          [min]="0" 
          [showButtons]="true">
        </p-inputNumber>
      </div>

      <div class="form-group mb-3">
        <label for="comentarios">Comentarios:</label>
        <textarea 
          pInputTextarea 
          formControlName="comentarios" 
          rows="3" 
          placeholder="Notas adicionales...">
        </textarea>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <button 
          pButton 
          label="‚Üê Volver" 
          class="p-button-secondary" 
          (click)="volver()">
        </button>

        <button 
          pButton 
          label="üíæ Guardar presupuesto" 
          class="p-button-success" 
          (click)="crearPresupuesto()" 
          [disabled]="formPresupuesto.invalid || items.length === 0">
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  .productos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .producto-card {
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.1rem;
  }

  .precio {
    color: #28a745;
    font-weight: bold;
  }

  .ingredientes {
    margin-top: 0.5rem;
    font-size: 0.9rem;
  }

  .badge {
    display: inline-block;
    margin-top: 0.5rem;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.8rem;
    color: white;
    font-weight: bold;
  }

  .vegano { background-color: #28a745; }
  .vegetariano { background-color: #007bff; }
  .otro { background-color: #6c757d; }

  .card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 1rem;
  }

  .cantidad-input {
    width: 70px;
  }

  .resumen-sidebar {
    width: 450px;
    padding: 1rem;
    background-color: #fff;
    color: #333;
  }

  .ver-sidebar-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
  }
</style>
