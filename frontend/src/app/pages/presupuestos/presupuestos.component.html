<p-toast></p-toast>

<div class="page">
  <div class="presupuesto-container">

    <!-- ===== Modal Confirmaci√≥n (Starbucks) ===== -->
    <div *ngIf="confirmVisible" class="sbx-confirm">
      <div class="sbx-overlay" (click)="cerrarConfirm()"></div>
      <div class="sbx-card" role="dialog" aria-modal="true" aria-labelledby="sbx-title">
        <div class="sbx-head">
          <span class="sbx-trash">üóëÔ∏è</span>
          <h4 id="sbx-title">Eliminar Presupuesto</h4>
        </div>

        <p class="sbx-question">
          ¬øSeguro que quer√©s borrar
          <strong>‚Äú{{ presupuestoAEliminar?.id }}‚Äù</strong>?
        </p>
        <p class="sbx-hint">Esta acci√≥n no se puede deshacer.</p>

        <div class="sbx-actions">
          <button type="button" class="sbx-btn cancel" (click)="cerrarConfirm()">Cancelar</button>
          <button type="button" class="sbx-btn danger" (click)="confirmarEliminar()">S√≠, borrar</button>
        </div>
      </div>
    </div>
    <!-- ===== /Modal ===== -->

    <!-- üìÅ Tabs -->
    <div class="tabs" *ngIf="!mostrarFormularioFinal">
      <button [class.active]="vista === 'productos'" (click)="vista = 'productos'">Productos</button>
      <button [class.active]="vista === 'presupuestos'" (click)="vista = 'presupuestos'">Presupuestos</button>
    </div>

    <!-- üõí TAB: Productos -->
    <div *ngIf="vista === 'productos' && !mostrarFormularioFinal">
      <h2>Armado de Presupuesto | Productos disponibles</h2>

      <div class="productos-grid">
        <div *ngFor="let prod of productos" class="producto-card">
          <div class="producto-header">
            <h3 class="producto-nombre">{{ prod.nombre }}</h3>
            <span class="producto-precio">${{ prod.precioUnitario }}</span>
          </div>

          <div class="producto-descripcion">
            <p>{{ prod.descripcion }}</p>
            <small><strong>Ingredientes:</strong> {{ prod.ingredientes }}</small>

            <span class="etiqueta"
              [ngClass]="{
                'etiqueta-vegano': prod.flag === 'VEGANO',
                'etiqueta-vegetariano': prod.flag === 'VEGETARIANO',
                'etiqueta-otro': prod.flag !== 'VEGANO' && prod.flag !== 'VEGETARIANO'
              }">
              {{ prod.flag === 'VEGANO' ? 'Vegano' : prod.flag === 'VEGETARIANO' ? 'Vegetariano' : 'Otro' }}
            </span>
          </div>

          <div class="card-footer">
            <input type="number" [(ngModel)]="prod.cantidadTemp" min="1" class="cantidad-input" />
            <button class="btn-agregar" (click)="agregarProducto(prod, prod.cantidadTemp || 1)">
              <i class="pi pi-plus"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Bot√≥n flotante SIEMPRE visible -->
      <button
        class="carrito-toggle"
        [disabled]="items.length === 0"
        (click)="toggleCarrito()"
        aria-label="Abrir carrito">
        <i class="pi pi-shopping-cart" aria-hidden="true"></i>
        <span class="badge" *ngIf="items.length">{{ items.length }}</span>
      </button>

      <!-- Panel lateral -->
      <div class="carrito-lateral" *ngIf="carritoAbierto" #carritoRef>
        <h3>üßæ √çtems seleccionados</h3>

        <div class="table-wrap">
          <table class="tabla-carrito">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cant.</th>
                <th>Precio</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of items; let i = index">
                <!-- üëá ahora muestra el nombre -->
                <td>{{ productoNombre(item.productoId) }}</td>
                <td>{{ item.cantidad }}</td>
                <td>{{ item.precioUnitario | currency: 'UYU' }}</td>
                <td>{{ item.totalItem | currency: 'UYU' }}</td>
                <td>
                  <button class="btn-eliminar" (click)="eliminarItem(i)">
                    <i class="pi pi-trash"></i>
                  </button>
                </td>
              </tr>
              <tr *ngIf="!items.length">
                <td colspan="5" style="text-align:center; padding:.75rem;">No hay productos agregados.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="text-right mt-3">
          <button class="btn-continuar" (click)="continuar()">Continuar ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- üìù Formulario Final -->
    <div *ngIf="mostrarFormularioFinal" class="formulario-final-wrapper">
      <div class="formulario-card" id="form-presupuesto-top">
        <h3>Completar presupuesto</h3>

        <form [formGroup]="formPresupuesto">
          <!-- Cliente -->
          <div class="form-group">
            <label for="cliente">Cliente</label>
            <small class="hint" id="clienteHint">Seleccion√° el cliente para asociar el presupuesto.</small>
            <select
              id="cliente"
              class="combo-cliente"
              formControlName="clienteId"
              [compareWith]="compareByString"
              aria-describedby="clienteHint"
              required>
              <option [ngValue]="null" disabled>Seleccionar cliente</option>
              <option *ngFor="let c of clientes" [ngValue]="c.id">{{ c.nombre }}</option>
            </select>
          </div>

          <!-- Estado -->
          <div class="form-group">
            <label for="estado">Estado</label>
            <small class="hint" id="estadoHint">Etapa del presupuesto: Propuesto, Aprobado o Rechazado.</small>
            <select
              id="estado"
              class="combo-cliente"
              formControlName="estado"
              [compareWith]="compareByString"
              aria-describedby="estadoHint"
              required>
              <option [ngValue]="null" disabled>Seleccionar estado</option>
              <option *ngFor="let e of estados" [ngValue]="e.value">{{ e.label }}</option>
            </select>
          </div>

          <!-- Tipo de evento -->
          <div class="form-group">
            <label for="tipoEvento">Tipo de evento</label>
            <small class="hint" id="eventoHint">El contexto del presupuesto (Cumplea√±os, Casamiento, Corporativo).</small>
            <select
              id="tipoEvento"
              class="combo-cliente"
              formControlName="tipoEvento"
              [compareWith]="compareByString"
              aria-describedby="eventoHint"
              required>
              <option [ngValue]="null" disabled>Seleccionar evento</option>
              <option *ngFor="let t of tiposEvento" [ngValue]="t.value">{{ t.label }}</option>
            </select>
          </div>

          <!-- Ganancia estimada -->
          <div class="form-group">
            <label for="gananciaEstimada">Ganancia estimada (UYU)</label>
            <small class="hint" id="gananciaHint">Ingres√° un n√∫mero entero (pod√©s poner 0 si a√∫n no lo sab√©s).</small>
            <input
              type="number"
              id="gananciaEstimada"
              formControlName="gananciaEstimada"
              min="0"
              placeholder="Ej.: 500"
              aria-describedby="gananciaHint" />
          </div>

          <!-- Comentarios -->
          <div class="form-group">
            <label for="comentarios">Comentarios</label>
            <small class="hint" id="comentariosHint">Notas internas, pedidos del cliente u otros detalles.</small>
            <textarea
              id="comentarios"
              rows="3"
              placeholder="Escrib√≠ comentarios adicionales‚Ä¶"
              formControlName="comentarios"
              aria-describedby="comentariosHint"></textarea>
          </div>

          <div class="form-buttons">
            <button type="button" class="cancelar" (click)="volver()">‚Üê Volver</button>
            <button
              type="button"
              class="guardar"
              [disabled]="formPresupuesto.invalid || items.length === 0"
              (click)="presupuestoEditandoId ? editarPresupuesto() : crearPresupuesto()">
              {{ presupuestoEditandoId ? 'Actualizar presupuesto' : 'Guardar presupuesto' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- üìë Tabla de Presupuestos -->
    <div *ngIf="vista === 'presupuestos' && !mostrarFormularioFinal" class="tabla-presupuestos-custom">
      <h3>Presupuestos anteriores</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Evento</th>
              <th>Comentarios</th>
              <th>Estado</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let pres of presupuestos">
              <td>{{ pres.id }}</td>
              <td>{{ pres.clienteId }}</td>
              <td>{{ pres.tipoEvento }}</td>
              <td>{{ pres.comentarios }}</td>
              <td>{{ pres.estado }}</td>
              <td>{{ obtenerTotal(pres) | currency: 'UYU' }}</td>
              <td class="acciones">
                <button class="editar-btn" (click)="cargarPresupuestoParaEditar(pres)">
                  <i class="pi pi-pencil"></i>
                </button>
                <button class="eliminar-btn" (click)="pedirEliminarPresupuesto(pres)">
                  <i class="pi pi-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
